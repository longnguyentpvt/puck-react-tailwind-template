name: PR Checks

on:
  pull_request:
    branches:
      - main

jobs:
  lint-and-build:
    name: Lint and Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run linting
        run: yarn lint

      - name: Build application
        run: yarn build

  docker-build-and-test:
    name: Docker Build and Playwright Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build -t puck-app:test .

      - name: Create network
        run: docker network create puck-network

      - name: Start MongoDB container
        run: |
          docker run -d \
            --name mongodb \
            --network puck-network \
            -e MONGO_INITDB_ROOT_USERNAME=admin \
            -e MONGO_INITDB_ROOT_PASSWORD=password \
            -p 27017:27017 \
            mongo:latest

      - name: Wait for MongoDB to be ready
        run: |
          echo "Waiting for MongoDB to be ready..."
          for i in {1..30}; do
            if docker exec mongodb mongo --eval "db.adminCommand('ping')" --quiet > /dev/null 2>&1 || \
               docker exec mongodb mongosh --eval "db.adminCommand('ping')" --quiet > /dev/null 2>&1; then
              echo "MongoDB is ready!"
              exit 0
            fi
            echo "Waiting for MongoDB... ($i/30)"
            sleep 2
          done
          echo "MongoDB failed to start in time"
          exit 1

      - name: Start application container
        run: |
          docker run -d \
            --name puck-app \
            --network puck-network \
            -e DATABASE_URI=mongodb://admin:password@mongodb:27017/puck?authSource=admin \
            -e PAYLOAD_SECRET=test-secret-key-for-ci \
            -e NEXT_PUBLIC_SERVER_URL=http://localhost:3000 \
            -p 3000:3000 \
            puck-app:test

      - name: Wait for application to be ready
        run: |
          echo "Waiting for application to start..."
          for i in {1..30}; do
            if curl -s http://localhost:3000 > /dev/null 2>&1; then
              echo "Application is ready!"
              docker logs puck-app
              exit 0
            fi
            echo "Waiting for application... ($i/30)"
            sleep 2
          done
          echo "Application failed to start in time"
          docker logs puck-app
          exit 1

      - name: Setup Node.js for Playwright
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Playwright tests
        run: yarn test:e2e
        env:
          BASE_URL: http://localhost:3000

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Cleanup containers
        if: always()
        run: |
          docker stop puck-app mongodb || true
          docker rm puck-app mongodb || true
          docker network rm puck-network || true
